// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id               String          @id @default(cuid())
  email            String             @unique
  passwordHash     String
  fullName         String
  username         String             @unique
  profilePicture   String? // S3 file URL
  region           String?
  conditions       UserCondition[]
  allergies        UserAllergy[]
  favorites        FavoriteRecipe[]
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
}

model Condition {
  id        String              @id @default(cuid())
  name      String              @unique // e.g. "Diabetes", "GERD", "Celiac"
  users     UserCondition[]
  recipes   RecipeCondition[]
}

model UserCondition {
  userId        String
  conditionId   String
  user          User        @relation(fields: [userId], references: [id])
  condition     Condition   @relation(fields: [conditionId], references: [id])

  @@id([userId, conditionId])
}

model Allergy {
  id        String            @id @default(cuid())
  name      String            @unique // e.g. "Nuts", "Dairy", "Shellfish"
  users     UserAllergy[]     @relation("UserAllergies")
  recipes   RecipeAllergy[]
}

model UserAllergy {
  userId      String
  allergyId   String
  user        User      @relation(fields: [userId], references: [id])
  allergy     Allergy   @relation("UserAllergies", fields: [allergyId], references: [id])

  @@id([userId, allergyId])
}

model Recipe {
  id              String              @id @default(cuid())
  title           String
  description     String?
  imageUrl        String?
  sourceUrl       String?
  ingredients     Json               // [{name: "egg", amount: "2", unit: "pcs"}]
  steps           Json               // ["Step 1...", "Step 2..."]
  nutritionInfo   Json?              // {calories: 200, carbs: 30, fat: 5}
  region          String?            // Default region (e.g., "US")
  conditions      RecipeCondition[]
  allergies       RecipeAllergy[]
  favorites       FavoriteRecipe[]
  createdAt       DateTime            @default(now())
}

model RecipeCondition {
  recipeId      String
  conditionId   String
  recipe        Recipe      @relation(fields: [recipeId], references: [id])
  condition     Condition   @relation(fields: [conditionId], references: [id])

  @@id([recipeId, conditionId])
}

model RecipeAllergy {
  recipeId    String
  allergyId   String
  recipe      Recipe    @relation(fields: [recipeId], references: [id])
  allergy     Allergy   @relation(fields: [allergyId], references: [id])

  @@id([recipeId, allergyId])
}

model FavoriteRecipe {
  userId     String
  recipeId   String
  user       User     @relation(fields: [userId], references: [id])
  recipe     Recipe   @relation(fields: [recipeId], references: [id])

  @@id([userId, recipeId])
}
